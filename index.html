<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LEDGIOX - Excel Migration Tool</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #121212;
    color: #e0e0e0;
    margin: 0;
}

/* Welcome Page Styles */
#welcomePage {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: #121212;
    color: #00e676;
    text-align: center;
    padding: 20px;
}
#welcomePage h1 {
    font-size: 3rem;
    margin-bottom: 20px;
}
#welcomePage p {
    font-size: 1.2rem;
    margin-bottom: 30px;
    max-width: 600px;
    line-height: 1.4;
}
#welcomePage button {
    padding: 15px 30px;
    font-size: 1.2rem;
    background: #00e676;
    color: #121212;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: 0.2s;
}
#welcomePage button:hover {
    background: #00c853;
}

header {
    background: #1f1f1f;
    color: #00e676;
    padding: 15px 20px;
    font-size: 1.6rem;
    font-weight: bold;
    box-shadow: 0 2px 6px rgba(0,0,0,0.5);
}

main {
    display: none;
    flex-wrap: wrap;
    padding: 20px;
    gap: 20px;
}

.sidebar {
    width: 280px;
    background: #1a1a1a;
    padding: 15px;
    border-radius: 10px;
    color: #e0e0e0;
    display: flex;
    flex-direction: column;
    gap: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.6);
}

.sidebar button, .sidebar input, .sidebar select {
    padding: 10px;
    font-size: 1rem;
    border-radius: 5px;
    border: none;
    cursor: pointer;
}

.sidebar button {
    background: #00e676;
    color: #121212;
    font-weight: bold;
    transition: 0.2s;
}

.sidebar button:hover {
    background: #00c853;
}

.sidebar input, .sidebar select {
    background: #2a2a2a;
    color: #e0e0e0;
    border: 1px solid #333;
}

.content {
    flex: 1;
    min-width: 300px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    height: calc(100vh - 60px);
}

table {
    width: 100%;
    border-collapse: collapse;
    background: #1f1f1f;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
}
th, td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #333;
}
th {
    background: #333;
    color: #00e676;
    position: sticky;
    top: 0;
}

tr:nth-child(even) {
    background: #1a1a1a;
}

tr:hover {
    background: #333;
}

.scrollable {
    flex: 1;
    overflow-y: auto;
    border-radius: 10px;
}

.debit { color: #00e676; font-weight: bold; }
.credit { color: #ff5252; font-weight: bold; }
.highlight { background: #ff9800 !important; color: #000; }

@media(max-width: 768px){
    main { flex-direction: column; }
    .sidebar { width: 100%; }
}

.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.tabButton {
    padding: 10px 20px;
    background: #1a1a1a;
    color: #e0e0e0;
    border: none;
    border-radius: 5px 5px 0 0;
    cursor: pointer;
    font-weight: bold;
    transition: 0.2s;
}

.tabButton.active {
    background: #00e676;
    color: #121212;
}

.tabButton:hover {
    background: #00c853;
}

.tabContent {
    display: none;
}

.custom-account-form {
    background: #2a2a2a;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.custom-account-form h3 {
    color: #00e676;
    margin-bottom: 15px;
}

.form-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}

.form-row input, .form-row select {
    flex: 1;
    min-width: 150px;
    padding: 8px;
    background: #1a1a1a;
    color: #e0e0e0;
    border: 1px solid #333;
    border-radius: 5px;
}

.custom-accounts-list {
    background: #1a1a1a;
    padding: 15px;
    border-radius: 10px;
    max-height: 300px;
    overflow-y: auto;
}

.account-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    border-bottom: 1px solid #333;
    flex-wrap: wrap;
    gap: 10px;
}

.account-item:last-child {
    border-bottom: none;
}

.remove-btn {
    background: #ff5252;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8rem;
}

.remove-btn:hover {
    background: #d32f2f;
}

/* Edit buttons for journal entries */
.edit-btn {
    background: #00e676;
    color: #121212;
    border: none;
    padding: 4px 8px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8rem;
    margin-right: 5px;
}

.edit-btn:hover {
    background: #00c853;
}

.save-btn {
    background: #4caf50;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8rem;
    margin-right: 5px;
}

.cancel-btn {
    background: #ff5252;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8rem;
}

.edit-input, .edit-select {
    background: #2a2a2a;
    color: #e0e0e0;
    border: 1px solid #333;
    padding: 4px;
    border-radius: 3px;
    width: 100%;
}

.instructions-content {
    background: #1f1f1f;
    padding: 20px;
    border-radius: 10px;
    line-height: 1.6;
}

.instructions-content h2 {
    color: #00e676;
    margin-bottom: 20px;
}

.instructions-content h3 {
    color: #00e676;
    margin-top: 20px;
    margin-bottom: 10px;
}

.instructions-content ul {
    margin-left: 20px;
}

.instructions-content li {
    margin-bottom: 5px;
}

.total-row {
    background: #333 !important;
    font-weight: bold;
    color: #00e676;
}

</style>
</head>
<body>
    <!-- Welcome Page -->
<div id="welcomePage">
    <h1>Welcome to LEDGIOX</h1>
    <p>
        LEDGIOX is made by accountants, for accountants. 
        Quickly convert your Excel or CSV data into accurate Journal Entries and a complete General Ledger. 
        Save time, reduce errors, and streamline your workflow. 
        Upload, generate, and export effortlessly to platforms like Zoho, QuickBooks, or Sage.
        For suggestions or feedback, email us at ledgiox@gmail.com
    </p>
    <button id="getStartedBtn">Get Started</button>
</div>

<header style="display:none;">LEDGIOX</header>
<main>
  <div class="sidebar">
    <label for="counterAccount">Counter Account</label>
    <input type="text" id="counterAccount" placeholder="Counter Account e.g. Cash or Bank">
    <label for="fileInput">Upload Excel/CSV</label>
    <input type="file" id="fileInput" accept=".xlsx,.csv">
    <button onclick="loadExcel()">Load Excel</button>
    <button onclick="generateJournal()">Generate Journal</button>
    <button onclick="generateLedger()">Generate General Ledger</button>
    <button onclick="downloadJournal()">Download Journal</button>
    <button onclick="downloadLedger()">Download Ledger</button>
    <button onclick="downloadTrialBalance()">Download Trial Balance</button>
    <button onclick="downloadSample()">Download Sample Excel</button>
    <label for="platformSelect">Export to Platform</label>
    <select id="platformSelect">
      <option value="">Select Platform</option>
      <option value="zoho">Zoho Books</option>
      <option value="quickbooks">QuickBooks</option>
      <option value="sage">Sage</option>
    </select>
    <button onclick="exportPlatform()">Export CSV</button>
  </div>

  <div class="content">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tabButton active" onclick="openTab(event, 'instructionsTab')">Instructions</button>
      <button class="tabButton" onclick="openTab(event, 'sampleTab')">Sample Excel</button>
      <button class="tabButton" onclick="openTab(event, 'journalTab')">Journal Entries</button>
      <button class="tabButton" onclick="openTab(event, 'ledgerTab')">General Ledger</button>
      <button class="tabButton" onclick="openTab(event, 'trialBalanceTab')">Trial Balance</button>
      <button class="tabButton" onclick="openTab(event, 'customTab')">Custom Accounts</button>
    </div>

    <!-- Instructions Tab -->
    <div id="instructionsTab" class="tabContent">
      <div class="instructions-content">
        <h2>How to Use LEDGIOX</h2>
        
        <h3>1. Prepare Your Data</h3>
        <p>Your Excel/CSV file must have these columns: <strong>Date, Description, Type (Payment/Receipt), Amount</strong></p>
        <p>Optionally include a <strong>Code</strong> column with accounting numbers (1000-8999) for automatic account classification</p>
        
        <h3>2. Account Code System</h3>
        <ul>
          <li><strong>1000-1999:</strong> Assets (Cash, Bank, Equipment, etc.)</li>
          <li><strong>2000-2999:</strong> Liabilities (Loans, Payables, etc.)</li>
          <li><strong>3000-3999:</strong> Equity (Capital, Drawings, etc.)</li>
          <li><strong>4000-4499:</strong> Revenue (Sales, Income, etc.)</li>
          <li><strong>4500-4599:</strong> Contra Revenue (Returns, Discounts)</li>
          <li><strong>5000-5999:</strong> Operating Expenses</li>
          <li><strong>6000-6999:</strong> Administrative Expenses</li>
          <li><strong>7000-7999:</strong> Other Income/Expenses</li>
          <li><strong>8000-8999:</strong> Extraordinary Items</li>
        </ul>
        
        <h3>3. Upload & Process</h3>
        <ol>
          <li>Set your counter account (usually Cash or Bank)</li>
             <li>Refer CodeLegend sheet in sample excel for default code</li>
          <li>Upload your Excel/CSV file</li>
          <li>Generate Journal Entries (edit if needed)</li>
          <li>Generate General Ledger and Trial Balance</li>
          <li>Export to your accounting platform</li>
        </ol>

        <h3>4. Editing Journal Entries</h3>
        <p>Click the edit button on any journal entry to modify accounts, amounts, or reclassify transactions. Changes automatically update the ledger and trial balance.</p>
      </div>
    </div>

    <!-- Sample Excel Tab -->
    <div id="sampleTab" class="tabContent">
      <div class="scrollable">
        <table id="sampleTable">
            <tr><th>Date</th><th>Description</th><th>Type</th><th>Amount</th><th>Account</th><th>Code</th><th>Category</th></tr>
        </table>
      </div>
    </div>

    <!-- Journal Entries Tab -->
    <div id="journalTab" class="tabContent">
      <div class="scrollable">
        <table id="journalTable">
            <tr><th>Date</th><th>Account</th><th>Code</th><th>Category</th><th>Debit</th><th>Credit</th><th>Description</th><th>Actions</th></tr>
        </table>
      </div>
    </div>

    <!-- General Ledger Tab -->
    <div id="ledgerTab" class="tabContent">
      <div class="scrollable">
        <table id="ledgerTable">
            <tr><th>Account</th><th>Code</th><th>Category</th><th>Date</th><th>Description</th><th>Debit</th><th>Credit</th><th>Balance</th></tr>
        </table>
      </div>
    </div>

    <!-- Trial Balance Tab -->
    <div id="trialBalanceTab" class="tabContent">
      <div class="scrollable">
        <table id="trialBalanceTable">
            <tr><th>Account</th><th>Code</th><th>Category</th><th>Debit</th><th>Credit</th></tr>
        </table>
      </div>
    </div>

    <!-- Custom Accounts Tab -->
    <div id="customTab" class="tabContent">
      <div class="custom-account-form">
        <h3>Add Custom Account</h3>
        <div class="form-row">
          <input type="text" id="customAccountName" placeholder="Account Name (e.g. custom inventory)">
          <input type="number" id="customAccountCode" placeholder="Account Code">
          <select id="customAccountCategory">
            <option value="">Select Category</option>
            <option value="asset">Asset (1000-1999)</option>
            <option value="liability">Liability (2000-2999)</option>
            <option value="equity">Equity (3000-3999)</option>
            <option value="revenue">Revenue (4000-4499)</option>
            <option value="expense">Expense (5000-6999)</option>
          </select>
          <button onclick="addCustomAccount()">Add</button>
        </div>
      </div>
      
      <div class="custom-accounts-list">
        <h3>Custom Accounts</h3>
        <div id="customAccountsList">
          <p>No custom accounts added yet.</p>
        </div>
      </div>
    </div>

  </div>
</main>

<script>
let sheetData = [];
let journal = [];
let ledger = {};
let trialBalance = [];
let customAccounts = {};
let editingEntryIndex = null;

const sampleData = [
  {Date:"2025-08-01", Description:"Office Supplies Purchase", Type:"Payment", Amount:120, Account:"office supplies"},
  {Date:"2025-08-02", Description:"Staff Lunch", Type:"Payment", Amount:45, Account:"travel & entertainment"},
  {Date:"2025-08-03", Description:"Legal Consultation", Type:"Payment", Amount:300, Account:"legal & professional fees"},
  {Date:"2025-08-04", Description:"Product Sale", Type:"Receipt", Amount:500, Account:"sale"},
  {Date:"2025-08-05", Description:"Car Fuel", Type:"Payment", Amount:60, Account:"travel & entertainment"},
  {Date:"2025-08-06", Description:"Asset Purchased – Computer", Type:"Payment", Amount:800, Account:"office equipment"},
  {Date:"2025-08-07", Description:"Asset Sold – Printer", Type:"Receipt", Amount:200, Account:"office equipment"},
  {Date:"2025-08-08", Description:"Discount Received", Type:"Receipt", Amount:50, Account:"discount allowed"},
  {Date:"2025-08-09", Description:"Stationery Purchase", Type:"Payment", Amount:70, Account:"office supplies"},
  {Date:"2025-08-10", Description:"Staff Snacks", Type:"Payment", Amount:30, Account:"travel & entertainment"},
  {Date:"2025-08-11", Description:"Sales Returned – Product A", Type:"Payment", Amount:100, Account:"return"},
  {Date:"2025-08-12", Description:"Legal Fee", Type:"Payment", Amount:250, Account:"legal & professional fees"},
  {Date:"2025-08-13", Description:"Printing Flyers", Type:"Payment", Amount:150, Account:"marketing & advertising"},
  {Date:"2025-08-14", Description:"Misc Expenses", Type:"Payment", Amount:60, Account:"miscellaneous expense"},
  {Date:"2025-08-15", Description:"Owner Capital Contribution", Type:"Receipt", Amount:1000, Account:"capital"},
  {Date:"2025-08-16", Description:"Owner Drawing", Type:"Payment", Amount:200, Account:"drawing"},
  {Date:"2025-08-17", Description:"Bank Interest Income", Type:"Receipt", Amount:75, Account:"interest"},
  {Date:"2025-08-18", Description:"Loan Repayment", Type:"Payment", Amount:500, Account:"short term loans"}
];

const accountCodes = {
  "Asset": { min: 1000, max: 1999, description: "Current & Fixed Assets" },
  "Liability": { min: 2000, max: 2999, description: "Current & Long-term Liabilities" },
  "Equity": { min: 3000, max: 3999, description: "Owner's Equity & Capital" },
  "Revenue": { min: 4000, max: 4499, description: "Operating Revenue" },
  "Contra Revenue": { min: 4500, max: 4599, description: "Returns & Discounts" },
  "Cost of Sales": { min: 5000, max: 5299, description: "Cost of Goods Sold / Direct Costs" },
  "Operating Expense": { min: 5300, max: 5999, description: "Operating Expenses" },
  "Administrative Expense": { min: 6000, max: 6999, description: "Admin & General Expenses" },
  "Other Income/Expense": { min: 7000, max: 7999, description: "Non-operating / Other Income & Expenses" },
  "Extraordinary": { min: 8000, max: 8999, description: "Extraordinary Items" }
};

const defaultAccountMapping = {
  // Assets
  "cash": 1000, "bank": 1010, "petty cash": 1020,
  "accounts receivable": 1100, "allowance doubtful accounts": 1110,
  "inventory": 1200, "raw materials": 1210, "work in progress": 1220,
  "finished goods": 1230, "prepaid expenses": 1300, "fixed assets": 1400,
  "accumulated depreciation": 1410, "buildings": 1420, "vehicles": 1430,
  "office equipment": 1440, "intangible assets": 1500, "other current assets": 1600,

  // Liabilities
  "accounts payable": 2000, "credit cards": 2100, "accrued expenses": 2200,
  "taxes payable": 2300, "short term loans": 2400, "long term debt": 2500,
  "employee benefits payable": 2600, "unearned revenue": 2700,
  "other current liabilities": 2800,

  // Equity
  "capital": 3000, "retained earnings": 3100, "drawing": 3200,
  "additional paid-in capital": 3300, "reserves": 3400, "treasury shares": 3500,

  // Revenue
  "sale": 4000, "product sales": 4010, "service revenue": 4020,
  "rental income": 4100, "interest": 4200, "other operating income": 4300,

  // Contra Revenue
  "return": 4500, "discount allowed": 4510,

  // Cost of Sales
  "cost of goods sold": 5000, "direct materials": 5100, "raw material purchases": 5110,
  "direct labor": 5120, "manufacturing overhead": 5200, "factory rent": 5210,
  "factory utilities": 5220,

  // Operating Expenses
  "salaries & wages": 5300, "employee benefits": 5310, "rent expense": 5400,
  "utilities": 5410, "electricity": 5411, "water": 5412, "internet/communication": 5413,
  "insurance": 5500, "depreciation expense": 5600, "marketing & advertising": 5700,
  "office supplies": 5800, "travel & entertainment": 5900,

  // Administrative & General Expenses
  "legal & professional fees": 6000, "training & development": 6100,
  "repairs & maintenance": 6200, "communication expense": 6300,
  "bank charges": 6400, "software subscriptions": 6500, "miscellaneous expense": 6600,

  // Other Income & Expenses
  "interest expense": 7100, "gain/loss on asset disposal": 7200,
  "foreign exchange gain/loss": 7300,

  // Extraordinary / Non-Operating
  "extraordinary gains": 8100, "extraordinary losses": 8200
};

function getAccountMapping() {
    return { ...defaultAccountMapping, ...customAccounts };
}

function detectAccountByCode(code) {
    const accountMapping = getAccountMapping();
    for (const [account, accCode] of Object.entries(accountMapping)) {
        if (accCode === code) return account;
    }
    return "miscellaneous expense";
}

function detectAccount(description, accountCode) {
    // First try to detect by account code if provided
    if (accountCode) {
        const accountByCode = detectAccountByCode(accountCode);
        if (accountByCode !== "miscellaneous expense") return accountByCode;
    }
    
    // Fallback to description-based detection
    const accountMapping = getAccountMapping();
    const lower = description ? description.toLowerCase() : "";
    for (const acc in accountMapping) {
        if (lower.includes(acc.toLowerCase())) return acc;
    }
    return "miscellaneous expense";
}

function getAccountTypeByCode(code) {
    for (const [type, range] of Object.entries(accountCodes)) {
        if (code >= range.min && code <= range.max) return type;
    }
    return "Unknown";
}

function formatDate(excelDate) {
    if (!excelDate) return "";
    if (!isNaN(excelDate)) {
        const jsDate = new Date((excelDate - 25569) * 86400 * 1000);
        return jsDate.toISOString().split("T")[0];
    }
    const parts = excelDate.split(/[-\/]/);
    if (parts.length === 3) {
        let day, month, year;
        if (parts[0].length === 4) [year, month, day] = parts;
        else [day, month, year] = parts;
        const parsed = new Date(`${year}-${month}-${day}`);
        if (!isNaN(parsed.getTime())) return parsed.toISOString().split("T")[0];
    }
    const fallback = new Date(excelDate);
    return !isNaN(fallback.getTime()) ? fallback.toISOString().split("T")[0] : "";
}

function populateSample() {
    const table = document.getElementById('sampleTable');
    table.innerHTML = `<tr>
        <th>Date</th>
        <th>Description</th>
        <th>Type</th>
        <th>Amount</th>
        <th>Account</th>
        <th>Code</th>
        <th>Category</th>
    </tr>`;

    const accountMapping = getAccountMapping();
    sampleData.forEach(row => {
        const account = detectAccount(row.Description, row.Code);
        const code = accountMapping[account] || 0;
        const category = getAccountTypeByCode(code);

        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.Date}</td>
                        <td>${row.Description}</td>
                        <td>${row.Type}</td>
                        <td>${row.Amount}</td>
                        <td>${account}</td>
                        <td>${code}</td>      
                        <td>${category}</td>`;  
        table.appendChild(tr);
    });
}

function validateSheet(data){
    const required = ["Date","Description","Type","Amount"];
    for(const row of data){
        for(const key of required){
            if(!(key in row) || row[key]==="") return false;
        }
    }
    return true;
}

function loadExcel() {
    const file = document.getElementById('fileInput').files[0];
    if(!file){ alert("Select a file first!"); return; }
    const reader = new FileReader();
    reader.onload = function(e){
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data,{type:"array"});
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
        if(!validateSheet(jsonData)){ alert("Excel missing required columns!"); return; }
        sheetData = jsonData;
        displaySheet(sheetData);
        alert("Excel loaded successfully!");
    }
    reader.readAsArrayBuffer(file);
}

function displaySheet(data){
    const table = document.getElementById('sampleTable');
    table.innerHTML = `<tr>
        <th>Date</th><th>Description</th><th>Type</th><th>Amount</th>
        <th>Account</th><th>Code</th><th>Category</th>
    </tr>`;
    
    const accountMapping = getAccountMapping();
    data.forEach(row => {
        const account = detectAccount(row.Description, row.Code);
        const code = accountMapping[account] || 6600;
        const category = getAccountTypeByCode(code);

        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${formatDate(row.Date)}</td>
                        <td>${row.Description}</td>
                        <td>${row.Type}</td>
                        <td>${row.Amount}</td>
                        <td>${account}</td>
                        <td>${code}</td>
                        <td>${category}</td>`;
        table.appendChild(tr);
    });
}

function generateJournal(){
    if(sheetData.length===0){ alert("Load data first!"); return; }
    journal = [];
    ledger = {};
    trialBalance = [];
    const counterAccount = document.getElementById('counterAccount').value || "cash";
    const accountMapping = getAccountMapping();

    sheetData.forEach(row => {
        const acc = detectAccount(row.Description, row.Code);
        const code = accountMapping[acc] || 0;
        const category = getAccountTypeByCode(code);
        const amount = parseFloat(row.Amount);
        const date = formatDate(row.Date);

        if(row.Type.toLowerCase()==="payment"){
            journal.push({Date:date,Account:acc,Code:code,Category:category,Debit:amount,Credit:0,Description:row.Description});
            journal.push({Date:date,Account:counterAccount,Code:accountMapping[counterAccount] || 1000,Category:"Asset",Debit:0,Credit:amount,Description:row.Description});
        } else {
            journal.push({Date:date,Account:counterAccount,Code:accountMapping[counterAccount] || 1000,Category:"Asset",Debit:amount,Credit:0,Description:row.Description});
            journal.push({Date:date,Account:acc,Code:code,Category:category,Debit:0,Credit:amount,Description:row.Description});
        }
    });
    displayJournal();
    alert("Journal generated!");
}

function displayJournal() {
    const table = document.getElementById('journalTable');
    table.innerHTML = '<tr><th>Date</th><th>Account</th><th>Code</th><th>Category</th><th>Debit</th><th>Credit</th><th>Description</th><th>Actions</th></tr>';

    const fragment = document.createDocumentFragment();
    journal.forEach((entry, index) => {
        const tr = document.createElement('tr');
        
        if (editingEntryIndex === index) {
            tr.innerHTML = `
                <td><input type="date" class="edit-input" value="${entry.Date}" id="edit-date-${index}"></td>
                <td>
                    <select class="edit-select" id="edit-account-${index}">
                        ${generateAccountOptions(entry.Account)}
                    </select>
                </td>
                <td><span id="edit-code-${index}">${entry.Code}</span></td>
                <td><span id="edit-category-${index}">${entry.Category}</span></td>
                <td><input type="number" step="0.01" class="edit-input" value="${entry.Debit || ''}" id="edit-debit-${index}"></td>
                <td><input type="number" step="0.01" class="edit-input" value="${entry.Credit || ''}" id="edit-credit-${index}"></td>
                <td><input type="text" class="edit-input" value="${entry.Description}" id="edit-description-${index}"></td>
                <td>
                    <button class="save-btn" onclick="saveEntry(${index})">Save</button>
                    <button class="cancel-btn" onclick="cancelEdit()">Cancel</button>
                </td>
            `;
        } else {
            tr.innerHTML = `
                <td>${entry.Date}</td>
                <td>${entry.Account}</td>
                <td>${entry.Code}</td>
                <td>${entry.Category}</td>
                <td class="debit">${entry.Debit || ''}</td>
                <td class="credit">${entry.Credit || ''}</td>
                <td>${entry.Description}</td>
                <td><button class="edit-btn" onclick="editEntry(${index})">Edit</button></td>
            `;
        }
        fragment.appendChild(tr);
    });
    table.appendChild(fragment);
}

function generateAccountOptions(selectedAccount) {
    const accountMapping = getAccountMapping();
    let options = '';
    for (const [account, code] of Object.entries(accountMapping)) {
        const selected = account === selectedAccount ? 'selected' : '';
        options += `<option value="${account}" ${selected}>${account} (${code})</option>`;
    }
    return options;
}

function editEntry(index) {
    editingEntryIndex = index;
    displayJournal();
    
    // Update code and category when account changes
    const accountSelect = document.getElementById(`edit-account-${index}`);
    if (accountSelect) {
        accountSelect.addEventListener('change', function() {
            const accountMapping = getAccountMapping();
            const code = accountMapping[this.value] || 0;
            const category = getAccountTypeByCode(code);
            document.getElementById(`edit-code-${index}`).textContent = code;
            document.getElementById(`edit-category-${index}`).textContent = category;
        });
    }
}

function saveEntry(index) {
    const accountMapping = getAccountMapping();
    const account = document.getElementById(`edit-account-${index}`).value;
    const code = accountMapping[account] || 0;
    const category = getAccountTypeByCode(code);
    
    journal[index] = {
        Date: document.getElementById(`edit-date-${index}`).value,
        Account: account,
        Code: code,
        Category: category,
        Debit: parseFloat(document.getElementById(`edit-debit-${index}`).value) || 0,
        Credit: parseFloat(document.getElementById(`edit-credit-${index}`).value) || 0,
        Description: document.getElementById(`edit-description-${index}`).value
    };
    
    editingEntryIndex = null;
    displayJournal();
    
    // Regenerate ledger and trial balance
    generateLedgerFromJournal();
    generateTrialBalanceFromJournal();
}

function cancelEdit() {
    editingEntryIndex = null;
    displayJournal();
}

function generateLedger(){
    if(journal.length===0){ alert("Generate journal first!"); return; }
    generateLedgerFromJournal();
    generateTrialBalanceFromJournal();
    displayLedger();
    alert("General Ledger generated!");
}

function generateLedgerFromJournal() {
    ledger = {};
    journal.forEach(entry => {
        if(!ledger[entry.Account]) ledger[entry.Account] = [];
        ledger[entry.Account].push({...entry});
    });
}

function generateTrialBalanceFromJournal() {
    const balances = {};
    
    journal.forEach(entry => {
        if (!balances[entry.Account]) {
            balances[entry.Account] = {
                debit: 0,
                credit: 0,
                account: entry.Account,
                code: entry.Code,
                category: entry.Category
            };
        }
        balances[entry.Account].debit += entry.Debit || 0;
        balances[entry.Account].credit += entry.Credit || 0;
    });

    trialBalance = Object.values(balances).map(balance => ({
        Account: balance.account,
        Code: balance.code,
        Category: balance.category,
        Debit: balance.debit > balance.credit ? balance.debit - balance.credit : 0,
        Credit: balance.credit > balance.debit ? balance.credit - balance.debit : 0
    }));
}

function displayLedger() {
    const table = document.getElementById('ledgerTable');
    table.innerHTML = '<tr><th>Account</th><th>Code</th><th>Category</th><th>Date</th><th>Description</th><th>Debit</th><th>Credit</th><th>Balance</th></tr>';

    const fragment = document.createDocumentFragment();
    for (const acc in ledger) {
        let balance = 0;
        ledger[acc].forEach(entry => {
            balance += (entry.Debit || 0) - (entry.Credit || 0);
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${entry.Account}</td>
                            <td>${entry.Code}</td>
                            <td>${entry.Category}</td>
                            <td>${entry.Date}</td>
                            <td>${entry.Description}</td>
                            <td class="debit">${(entry.Debit||0).toFixed(2)}</td>
                            <td class="credit">${(entry.Credit||0).toFixed(2)}</td>
                            <td>${balance.toFixed(2)}</td>`;
            fragment.appendChild(tr);
        });
    }
    table.appendChild(fragment);
}

function displayTrialBalance() {
    const table = document.getElementById('trialBalanceTable');
    table.innerHTML = '<tr><th>Account</th><th>Code</th><th>Category</th><th>Debit</th><th>Credit</th></tr>';

    const fragment = document.createDocumentFragment();
    let totalDebits = 0;
    let totalCredits = 0;
    
    trialBalance.forEach(entry => {
        totalDebits += entry.Debit || 0;
        totalCredits += entry.Credit || 0;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${entry.Account}</td>
                        <td>${entry.Code}</td>
                        <td>${entry.Category}</td>
                        <td class="debit">${entry.Debit ? entry.Debit.toFixed(2) : '0.00'}</td>
                        <td class="credit">${entry.Credit ? entry.Credit.toFixed(2) : '0.00'}</td>`;
        fragment.appendChild(tr);
    });
    
    // Add total row
    const totalRow = document.createElement('tr');
    totalRow.className = 'total-row';
    totalRow.innerHTML = `<td colspan="3"><strong>TOTAL</strong></td>
                          <td class="debit"><strong>${totalDebits.toFixed(2)}</strong></td>
                          <td class="credit"><strong>${totalCredits.toFixed(2)}</strong></td>`;
    fragment.appendChild(totalRow);
    
    table.appendChild(fragment);
}

function downloadJournal(){
    if(journal.length===0){ 
        alert("Generate journal first!"); 
        return; 
    }

    const exportData = journal.map(entry => ({
        Date: entry.Date,
        Account: entry.Account,
        Code: entry.Code,
        Category: entry.Category,
        Debit: entry.Debit,
        Credit: entry.Credit,
        Description: entry.Description
    }));

    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Journal");
    XLSX.writeFile(wb, "Journal.xlsx");
}

function downloadTrialBalance(){
    if(trialBalance.length===0){ 
        alert("Generate trial balance first!"); 
        return; 
    }

    const exportData = trialBalance.map(entry => ({
        Account: entry.Account,
        Code: entry.Code,
        Category: entry.Category,
        Debit: entry.Debit,
        Credit: entry.Credit
    }));

    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Trial Balance");
    XLSX.writeFile(wb, "TrialBalance.xlsx");
}

function downloadLedger(){
    if(Object.keys(ledger).length === 0){
        alert("Generate ledger first!");
        return;
    }

    const monthlyLedger = {};

    for(const acc in ledger){
        ledger[acc].forEach(entry => {
            const dateObj = new Date(entry.Date);
            const ym = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}`;
            if(!monthlyLedger[ym]) monthlyLedger[ym] = [];

            monthlyLedger[ym].push({
                Account: acc,
                Code: entry.Code,
                Category: entry.Category,
                Date: entry.Date,
                Description: entry.Description,
                Debit: entry.Debit || 0,
                Credit: entry.Credit || 0,
                Balance: 0
            });
        });
    }

    for(const ym in monthlyLedger){
        let balances = {};
        monthlyLedger[ym] = monthlyLedger[ym].map(entry => {
            if(!balances[entry.Account]) balances[entry.Account] = 0;
            balances[entry.Account] += (entry.Debit || 0) - (entry.Credit || 0);
            return {...entry, Balance: balances[entry.Account]};
        });
    }

    for(const month in monthlyLedger){
        const ws = XLSX.utils.json_to_sheet(monthlyLedger[month]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ledger");
        XLSX.writeFile(wb, `Ledger_${month}.xlsx`);
    }

    alert("Ledger exported as monthly files!");
}

function exportPlatform() {
    if (!journal || journal.length === 0) {
        alert("No journal data to export!");
        return;
    }

    const platform = document.getElementById("platformSelect").value;
    if (!platform) { 
        alert("Select a platform!"); 
        return; 
    }

    let exportData = [];

    if (platform === "zoho") {
        exportData = journal.map(entry => ({
            "Date": entry.Date,
            "Account Name": entry.Account,
            "Code": entry.Code,
            "Category": entry.Category,
            "Debit": entry.Debit,
            "Credit": entry.Credit,
            "Description": entry.Description
        }));
    } else if (platform === "quickbooks") {
        exportData = journal.map(entry => ({
            "TxnDate": entry.Date,
            "Account": entry.Account,
            "Code": entry.Code,
            "Category": entry.Category,
            "Debit": entry.Debit,
            "Credit": entry.Credit,
            "Memo": entry.Description
        }));
    } else if (platform === "sage") {
        exportData = journal.map(entry => ({
            "Date": entry.Date,
            "NominalCode": entry.Code,
            "Category": entry.Category,
            "Description": entry.Description,
            "DebitAmount": entry.Debit || 0,
            "CreditAmount": entry.Credit || 0
        }));
    }

    function convertToCSV(objArray) {
        const array = typeof objArray !== 'object' ? JSON.parse(objArray) : objArray;
        let str = '';
        const headers = Object.keys(array[0]).join(',');
        str += headers + '\r\n';

        array.forEach(item => {
            let line = [];
            for (let key in item) {
                let val = item[key] != null ? item[key] : '';
                val = `"${val.toString().replace(/"/g, '""')}"`;
                line.push(val);
            }
            str += line.join(',') + '\r\n';
        });
        return str;
    }

    const csv = convertToCSV(exportData);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.setAttribute('download', `${platform}_Export.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    alert(`Journal exported for ${platform}!`);
}

function downloadSample() {
    const accountMapping = getAccountMapping();
    const sampleDataWithCodes = sampleData.map(row => {
        const account = detectAccount(row.Description, row.Code);
        const code = accountMapping[account] || 0;
        const category = getAccountTypeByCode(code);
        return {
            Date: row.Date,
            Description: row.Description,
            Type: row.Type,
            Amount: row.Amount,
            Account: account,
            Code: code,
            Category: category
        };
    });

    const wsSample = XLSX.utils.json_to_sheet(sampleDataWithCodes, { 
        header: ["Date", "Description", "Type", "Amount", "Account", "Code", "Category"]
    });

    const legendData = [
        { Category: "Cash (Asset)", Code: 1000 },
        { Category: "Bank (Asset)", Code: 1010 },
        { Category: "Petty Cash (Asset)", Code: 1020 },
        { Category: "Accounts Receivable (Asset)", Code: 1100 },
        { Category: "Allowance Doubtful Accounts (Asset)", Code: 1110 },
        { Category: "Inventory (Asset)", Code: 1200 },
        { Category: "Raw Materials (Asset)", Code: 1210 },
        { Category: "Work In Progress (Asset)", Code: 1220 },
        { Category: "Finished Goods (Asset)", Code: 1230 },
        { Category: "Prepaid Expenses (Asset)", Code: 1300 },
        { Category: "Fixed Assets (Asset)", Code: 1400 },
        { Category: "Accumulated Depreciation (Asset)", Code: 1410 },
        { Category: "Buildings (Asset)", Code: 1420 },
        { Category: "Vehicles (Asset)", Code: 1430 },
        { Category: "Office Equipment (Asset)", Code: 1440 },
        { Category: "Intangible Assets (Asset)", Code: 1500 },
        { Category: "Other Current Assets (Asset)", Code: 1600 },
        
        { Category: "Accounts Payable (Liability)", Code: 2000 },
        { Category: "Credit Cards (Liability)", Code: 2100 },
        { Category: "Accrued Expenses (Liability)", Code: 2200 },
        { Category: "Taxes Payable (Liability)", Code: 2300 },
        { Category: "Short Term Loans (Liability)", Code: 2400 },
        { Category: "Long Term Debt (Liability)", Code: 2500 },
        { Category: "Employee Benefits Payable (Liability)", Code: 2600 },
        { Category: "Unearned Revenue (Liability)", Code: 2700 },
        { Category: "Other Current Liabilities (Liability)", Code: 2800 },
        
        { Category: "Capital (Equity)", Code: 3000 },
        { Category: "Retained Earnings (Equity)", Code: 3100 },
        { Category: "Drawing (Equity)", Code: 3200 },
        { Category: "Additional Paid-In Capital (Equity)", Code: 3300 },
        { Category: "Reserves (Equity)", Code: 3400 },
        { Category: "Treasury Shares (Equity)", Code: 3500 },
        
        { Category: "Sale (Revenue)", Code: 4000 },
        { Category: "Product Sales (Revenue)", Code: 4010 },
        { Category: "Service Revenue (Revenue)", Code: 4020 },
        { Category: "Rental Income (Revenue)", Code: 4100 },
        { Category: "Interest (Revenue)", Code: 4200 },
        { Category: "Other Operating Income (Revenue)", Code: 4300 },
        
        { Category: "Return (Contra Revenue)", Code: 4500 },
        { Category: "Discount Allowed (Contra Revenue)", Code: 4510 },
        
        { Category: "Cost of Goods Sold (Operating Expense)", Code: 5000 },
        { Category: "Direct Materials (Operating Expense)", Code: 5100 },
        { Category: "Raw Material Purchases (Operating Expense)", Code: 5110 },
        { Category: "Direct Labor (Operating Expense)", Code: 5120 },
        { Category: "Manufacturing Overhead (Operating Expense)", Code: 5200 },
        { Category: "Factory Rent (Operating Expense)", Code: 5210 },
        { Category: "Factory Utilities (Operating Expense)", Code: 5220 },
        
        { Category: "Salaries & Wages (Operating Expense)", Code: 5300 },
        { Category: "Employee Benefits (Operating Expense)", Code: 5310 },
        { Category: "Rent Expense (Operating Expense)", Code: 5400 },
        { Category: "Utilities (Operating Expense)", Code: 5410 },
        { Category: "Electricity (Operating Expense)", Code: 5411 },
        { Category: "Water (Operating Expense)", Code: 5412 },
        { Category: "Internet/Communication (Operating Expense)", Code: 5413 },
        { Category: "Insurance (Operating Expense)", Code: 5500 },
        { Category: "Depreciation Expense (Operating Expense)", Code: 5600 },
        { Category: "Marketing & Advertising (Operating Expense)", Code: 5700 },
        { Category: "Office Supplies (Operating Expense)", Code: 5800 },
        { Category: "Travel & Entertainment (Operating Expense)", Code: 5900 },
        
        { Category: "Legal & Professional Fees (Administrative Expense)", Code: 6000 },
        { Category: "Training & Development (Administrative Expense)", Code: 6100 },
        { Category: "Repairs & Maintenance (Administrative Expense)", Code: 6200 },
        { Category: "Communication Expense (Administrative Expense)", Code: 6300 },
        { Category: "Bank Charges (Administrative Expense)", Code: 6400 },
        { Category: "Software Subscriptions (Administrative Expense)", Code: 6500 },
        { Category: "Miscellaneous Expense (Administrative Expense)", Code: 6600 },
        
        { Category: "Interest Expense (Other Income/Expense)", Code: 7100 },
        { Category: "Gain/Loss on Asset Disposal (Other Income/Expense)", Code: 7200 },
        { Category: "Foreign Exchange Gain/Loss (Other Income/Expense)", Code: 7300 },
        
        { Category: "Extraordinary Gains (Extraordinary/Non-Operating)", Code: 8100 },
        { Category: "Extraordinary Losses (Extraordinary/Non-Operating)", Code: 8200 }
    ];

    const wsLegend = XLSX.utils.json_to_sheet(legendData, {
        header: ["Category", "Code"]
    });

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, wsSample, "Sample Data");
    XLSX.utils.book_append_sheet(wb, wsLegend, "Code Legend");
    XLSX.writeFile(wb, "SamplePettyCash.xlsx");
}

function addCustomAccount() {
    const name = document.getElementById('customAccountName').value.trim().toLowerCase();
    const code = parseInt(document.getElementById('customAccountCode').value);
    const category = document.getElementById('customAccountCategory').value;
    
    if (!name || !code || !category) {
        alert('Please fill in all fields');
        return;
    }
    
    const codeRanges = {
        'asset': { min: 1000, max: 1999 },
        'liability': { min: 2000, max: 2999 },
        'equity': { min: 3000, max: 3999 },
        'revenue': { min: 4000, max: 4499 },
        'expense': { min: 5000, max: 6999 }
    };
    
    const range = codeRanges[category];
    if (code < range.min || code > range.max) {
        alert(`Code must be between ${range.min} and ${range.max} for ${category}`);
        return;
    }
    
    customAccounts[name] = code;
    
    document.getElementById('customAccountName').value = '';
    document.getElementById('customAccountCode').value = '';
    document.getElementById('customAccountCategory').value = '';
    
    displayCustomAccounts();
    populateSample();
    alert('Custom account added successfully!');
}

function removeCustomAccount(accountName) {
    delete customAccounts[accountName];
    displayCustomAccounts();
    populateSample();
}

function displayCustomAccounts() {
    const container = document.getElementById('customAccountsList');
    
    if (Object.keys(customAccounts).length === 0) {
        container.innerHTML = '<p>No custom accounts added yet.</p>';
        return;
    }
    
    let html = '';
    for (const [name, code] of Object.entries(customAccounts)) {
        const category = getAccountTypeByCode(code);
        html += `
            <div class="account-item">
                <span><strong>${name}</strong> - ${code} (${category})</span>
                <button class="remove-btn" onclick="removeCustomAccount('${name}')">Remove</button>
            </div>
        `;
    }
    container.innerHTML = html;
}

function openTab(evt, tabName) {
    const tabContents = document.getElementsByClassName("tabContent");
    for (let i = 0; i < tabContents.length; i++) tabContents[i].style.display = "none";

    const tabButtons = document.getElementsByClassName("tabButton");
    for (let i = 0; i < tabButtons.length; i++) tabButtons[i].classList.remove("active");

    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.classList.add("active");

    if (tabName === "journalTab" && journal.length > 0) displayJournal();
    if (tabName === "ledgerTab" && Object.keys(ledger).length > 0) displayLedger();
    if (tabName === "trialBalanceTab" && trialBalance.length > 0) displayTrialBalance();
    if (tabName === "customTab") displayCustomAccounts();
}

window.onload = function() {
    populateSample();
    document.getElementById("instructionsTab").style.display = "block";
};

document.getElementById('getStartedBtn').addEventListener('click', () => {
    document.getElementById('welcomePage').style.display = 'none';
    document.querySelector('main').style.display = 'flex';
    document.querySelector('header').style.display = 'block';
});

</script>

</body>
</html>

